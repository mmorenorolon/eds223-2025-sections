---
title: "discussion_week6"
format: html
editor_options: 
  chunk_output_type: console
---
##1. Set Up
```{r}
# Load necessary packages
library(tidyverse)
library(sf)
library(terra)
library(tmap)
library(tmaptools)
```


```{r}
# Set directory for folder
pre_fire_dir <- here::here("data", "week6-data", "data", 
                           "LC80340322016189-SC20170128091153")

# Create a list of all images that have the extension .tif and contain the word band
pre_fire_bands <- list.files(pre_fire_dir,
                             pattern = glob2rx("*band*.tif$"),
                             full.names = TRUE)
# Create a raster stack
pre_fire_rast <- rast(pre_fire_bands)

# Read mask raster
pre_mask <- rast(here::here("data","week6-data", "data", "LC80340322016189-SC20170128091153", "LC80340322016189LGN00_cfmask_crop.tif"))
```

```{r}
# Set directory for folder
post_fire_dir <- here::here("data","week6-data","data",
                            "LC80340322016205-SC20170127160728")

# Create a list of all images that have the extension .tif and contain the word band
post_fire_bands <- list.files(post_fire_dir,
                             pattern = glob2rx("*band*.tif$"),
                             full.names = TRUE)
# Create a raster stack
post_fire_rast <- rast(post_fire_bands)

# Read mask raster
post_mask <- rast(here::here("data","week6-data","data", "LC80340322016205-SC20170127160728", "LC80340322016205LGN00_cfmask_crop.tif"))
```

And define the nbr_fun function to calculate the normalized burn ratio (NBR):
```{r}
nbr_fun <- function(nir, swir2){
    (nir - swir2)/(nir + swir2)
}
```

##2. Rename and mask the bands
Rename the bands of the pre_fire and post_fire rasters using names()

```{r}
# Rename bands
bands <- c("Aerosol", "Blue", "Green", "Red", "NIR", "SWIR1", "SWIR2")
names(pre_fire_rast) <- bands
names(post_fire_rast) <- bands
```

Mask out clouds and shadows of the pre_mask and post_mask rasters (i.e., set mask > 0 to NA)
```{r}
# Set all cells with values greater than 0 to NA
pre_mask[pre_mask > 0] <- NA

# Subset raster based on mask
pre_fire_rast <- mask(pre_fire_rast, mask = pre_mask)

# View raster
plot(pre_fire_rast)
```

```{r}
# Set all cells with values greater than 0 to NA
post_mask[post_mask > 0] <- NA

# Subset raster based on mask
post_fire_rast <- mask(post_fire_rast, mask = post_mask)

# View raster
plot(post_fire_rast)
```

##3. Plot true and false color composites

- Plot a true color composite using plotRGB()
- Map the red band to the red channel, green to green, and blue to blue
- Apply a linear stretch “lin” or histogram equalization “hist”

```{r}
# View histogram for each band
hist(pre_fire_rast,
     maxpixels = ncell(pre_fire_rast),
     col = "tan")

# Plot true color composite for pre_fire_rast
plotRGB(pre_fire_rast,r = 4, g = 3, b = 2, stretch = 'lin', colNA = "black")


# Plot true color composite for post_fire_rast
plotRGB(post_fire_rast,r = 4, g = 3, b = 2, stretch = 'lin', colNA = "black")

```

- Plot two false color composite using plotRGB()
- Map the SWIR2 band to the red channel, NIR to green, and green to blue
- Apply a linear stretch “lin” or histogram equalization “hist”

```{r}
# Plot false color composite for pre_fire_rast
plotRGB(pre_fire_rast,r = 4, g = 3, b = 2, stretch = 'lin', colNA = "black")

# Plot false color composite for post_fire_rast
plotRGB(post_fire_rast,r = 7, g = 5, b = 3, stretch = 'lin', colNA = "black")
```

##4. Calculate the normalized burn ratio (NBR)

- Calculate the normalized burn ratio (NBR)
Hint: Use lapp() like you previously did for NDVI and NDWI in Week 4

```{r}
# apply NBR function to bands 5 & 7
nbr_pre_fire_rast <- lapp(pre_fire_rast[[c(5, 7)]], fun = nbr_fun)

tm_shape(nbr_pre_fire_rast) +
  tm_raster(col.legend = tm_legend(title = "NBR"),
            fill.scale = tm_scale_intervals(midpoint = NA)) +
  tm_title(text = "Cold Springs Pre-Fire NBR")
```

```{r}
nbr_post_fire_rast <- lapp(post_fire_rast[[c(5, 7)]], fun = nbr_fun)

tm_shape(nbr_post_fire_rast) +
  tm_raster(col.legend = tm_legend(title = "NBR"),
            fill.scale = tm_scale_intervals(midpoint = NA)) +
  tm_title(text = "Cold Springs Post-Fire NBR")
```

##6. Calculate and plot difference NBR

- Find the difference NBR
- Plot the d_NBR raster
```{r}
d_nbr <- nbr_post_fire_rast - nbr_pre_fire_rast

tm_shape(d_nbr) +
  tm_raster(style = "equal", n = 6, 
            palette = "YlOrRd", n = 6,
            title = "Difference NBR (dNBR)", colorNA = "black") +
  tm_title(text = "Cold Springs Fire DNBR") +
  tm_layout(legend.outside = TRUE)
```

